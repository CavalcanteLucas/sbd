# 3.02

Suponha que você tenha recebido uma relação $nota\_pontos(\underline{nota}, pontos)$, que oferece uma conversão de notas com letras na relação $realiza$ para notas numéricas; por exemplo, uma nota "A" poderia ser especificada para corresponder a 4 pontos, um "A-" para 3,7 pontos, "B+" para 3,3 pontos, "B" para 3 pontos e assim por diante. Os pontos da nota obtidos por um aluno para uma oferta de curso (se\c{c}ão) são definidos como o número de créditos para o curso multiplicado pelos pontos nuḿericos para a nota que o aluno recebeu.

Dada essa relação e nosso esquema de universidade, escreve cada uma das seguintes consultas em SQL. Você pode considerar, para simplificar, que nenhuma tupla $realiza$ tem o valor $null$ para $nota$.

**a)** Ache os pontos totais recebidos pelo aluno com ID '12345', por todos os cursos realizados por ele.

**b)** Ache a média de pontos (*coeficiente de rendimento*, ou CR) para esse mesmo aluno, ou seja, o total de pontos divididos pelo total de créditos para os cursos associados.

**c)** Agora considere suas respostas dos items anteriores deste exercício supondo que algumas notas possam ser nulas. Explique se as suas soluções ainda funcionam e, se não, ofereça versões que tratem corretamente dos nulos.

## Resposta

Preparando a tabela `nota_pontos`:

```
DROP TABLE nota_pontos;

CREATE TABLE nota_pontos (
  grade VARCHAR(2) PRIMARY KEY,
  points DECIMAL(3,2)
);

INSERT INTO nota_pontos (grade, points) VALUES
  ('A', 4.0),
  ('A-', 3.7),
  ('B+', 3.3),
  ('B', 3.0),
  ('B-', 2.7),
  ('C+', 2.3),
  ('C', 2.0),
  ('C-', 1.7),
  ('D', 1.3),
  ('D-', 1.0),
  ('E', 0.7),
  ('E-', 0.3),
  ('F', 0.0);

SELECT * FROM nota_pontos;
```

**a)**

```
SELECT COALESCE(SUM(n.points * c.credits), 0)
FROM takes t
JOIN nota_pontos n ON n.grade = t.grade
JOIN course c ON c.course_id = t.course_id
WHERE t.id = '12345'
```

**b)**

```
SELECT COALESCE(SUM(n.points * c.credits)/SUM(c.credits), 0)
FROM takes t
JOIN nota_pontos n ON n.grade = t.grade
JOIN course c ON c.course_id = t.course_id
WHERE t.id = '12345'
```

**c)**

```
SELECT t.id, COALESCE(SUM(n.points * c.credits)/SUM(c.credits), 0)
FROM takes t
JOIN nota_pontos n ON n.grade = t.grade
JOIN course c ON c.course_id = t.course_id
GROUP BY t.id
```

**d)**

As soluções apresentadas não geram linhas para a junção entre `takes` e
`nota_pontos`, então esses casos não afetariam o cálculo da soma, nem da
média.

Caso um aluno não possua cursos registrados, nenhuma linha seria retornada.
Então o resultado seria `NULL`. No entanto, a cláusula `COALESCE`
garante que, nesta situação, o resultado seja 0.
